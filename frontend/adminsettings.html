<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Settings - IT Ticket System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f3f4f6; }
        .section { display: none; }
        .section.active { display: block; }
        .nav-item.active { background-color: #3b82f6; color: white; }
    </style>
</head>
<body>
    <div class="min-h-screen flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white border-r border-gray-200 min-h-screen">
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-lg font-bold text-gray-800">Admin Settings</h1>
                <p class="text-xs text-gray-500">System Configuration</p>
            </div>
            <nav class="p-2">
                <button onclick="showSection('filters')" class="nav-item w-full flex items-center px-4 py-3 text-left text-gray-700 rounded-lg hover:bg-gray-100 transition">
                    <i data-lucide="filter" class="w-5 h-5 mr-3"></i>
                    Filter Management
                </button>
                <button onclick="showSection('scan')" class="nav-item w-full flex items-center px-4 py-3 text-left text-gray-700 rounded-lg hover:bg-gray-100 transition">
                    <i data-lucide="mail-search" class="w-5 h-5 mr-3"></i>
                    Email Scan
                </button>
                <button onclick="showSection('tickets')" class="nav-item w-full flex items-center px-4 py-3 text-left text-gray-700 rounded-lg hover:bg-gray-100 transition">
                    <i data-lucide="ticket" class="w-5 h-5 mr-3"></i>
                    Ticket Settings
                </button>
                <button onclick="showSection('data')" class="nav-item w-full flex items-center px-4 py-3 text-left text-gray-700 rounded-lg hover:bg-gray-100 transition">
                    <i data-lucide="database" class="w-5 h-5 mr-3"></i>
                    Data Management
                </button>
                <button onclick="showSection('system')" class="nav-item w-full flex items-center px-4 py-3 text-left text-gray-700 rounded-lg hover:bg-gray-100 transition">
                    <i data-lucide="info" class="w-5 h-5 mr-3"></i>
                    System Info
                </button>
            </nav>
            <div class="absolute bottom-0 w-64 p-4 border-t border-gray-200">
                <a href="dashboard.html" class="flex items-center justify-center w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition">
                    <i data-lucide="home" class="w-4 h-4 mr-2"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            <!-- Filter Management Section -->
            <div id="section-filters" class="section active">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Filter Management</h2>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Email Filters</h3>
                        <button onclick="openFilterModal()" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                            Add Filter
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">From Email</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Subject Filter</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Action</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="filtersTable" class="divide-y divide-gray-200">
                                <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-2">Available Actions</h4>
                    <p class="text-sm text-blue-700">extract_cdc, send_mx_alert, urgent_mx_notification, process_health_data, log_cdc_data</p>
                </div>
            </div>

            <!-- Email Scan Section -->
            <div id="section-scan" class="section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Email Scan Controls</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-100 p-3 rounded-lg mr-4">
                                <i data-lucide="zap" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Quick Scan</h3>
                                <p class="text-sm text-gray-500">Scan 50 most recent emails</p>
                            </div>
                        </div>
                        <button onclick="runScan('quick')" id="quickScanBtn" class="w-full flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                            Start Quick Scan
                        </button>
                        <p class="text-xs text-gray-500 mt-2 text-center">Estimated time: &lt;30 seconds</p>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-purple-100 p-3 rounded-lg mr-4">
                                <i data-lucide="硬盘" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Full Scan</h3>
                                <p class="text-sm text-gray-500">Scan ALL emails in mailbox</p>
                            </div>
                        </div>
                        <button onclick="runScan('full')" id="fullScanBtn" class="w-full flex items-center justify-center px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                            <i data-lucide="play" class="w-4 h-4 mr-2"></i>
                            Start Full Scan
                        </button>
                        <p class="text-xs text-gray-500 mt-2 text-center">Estimated time: Several minutes</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Scan Options</h3>
                    <label class="flex items-center">
                        <input type="checkbox" id="autoRefreshAfterScan" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                        <span class="ml-2 text-gray-700">Auto-refresh dashboard after scan completes</span>
                    </label>
                </div>

                <div id="scanStatus" class="hidden mt-6 bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <div class="animate-spin mr-3">
                            <i data-lucide="loader-2" class="w-5 h-5 text-green-600"></i>
                        </div>
                        <span id="scanStatusText" class="text-green-700">Scanning emails...</span>
                    </div>
                </div>

                <div id="scanResult" class="hidden mt-6 bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-2"></i>
                        <span id="scanResultText" class="text-green-700"></span>
                    </div>
                </div>
            </div>

            <!-- Ticket Settings Section -->
            <div id="section-tickets" class="section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Ticket Settings</h2>
                
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Default Values</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Status</label>
                            <select id="defaultStatus" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="in progress">In Progress</option>
                                <option value="pending">Pending</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Default Handler</label>
                            <select id="defaultHandler" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="USE_MISSING">USE_MISSING</option>
                                <option value="CC">CC</option>
                                <option value="TW">TW</option>
                                <option value="TS">TS</option>
                                <option value="TC">TC</option>
                                <option value="HA">HA</option>
                                <option value="GL">GL</option>
                                <option value="NT">NT</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Dashboard Auto-Refresh</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="autoRefreshEnabled" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-gray-700">Enable auto-refresh</span>
                            </label>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Refresh Interval</label>
                            <select id="refreshInterval" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="30">30 seconds</option>
                                <option value="60">1 minute</option>
                                <option value="300">5 minutes</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button onclick="saveSettings()" class="mt-6 flex items-center px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                    <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                    Save Settings
                </button>
            </div>

            <!-- Data Management Section -->
            <div id="section-data" class="section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Data Management</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-green-100 p-3 rounded-lg mr-4">
                                <i data-lucide="download" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Export Tickets</h3>
                                <p class="text-sm text-gray-500">Download all tickets as JSON</p>
                            </div>
                        </div>
                        <button onclick="exportData('tickets')" class="w-full flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            Export Tickets
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-100 p-3 rounded-lg mr-4">
                                <i data-lucide="mail" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Export Emails</h3>
                                <p class="text-sm text-gray-500">Download cached emails as JSON</p>
                            </div>
                        </div>
                        <button onclick="exportData('emails')" class="w-full flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                            Export Emails
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-yellow-100 p-3 rounded-lg mr-4">
                                <i data-lucide="archive" class="w-6 h-6 text-yellow-600"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Create Backup</h3>
                                <p class="text-sm text-gray-500">Backup tickets, filters, and emails</p>
                            </div>
                        </div>
                        <button onclick="createBackup()" class="w-full flex items-center justify-center px-4 py-3 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition">
                            <i data-lucide="archive" class="w-4 h-4 mr-2"></i>
                            Create Backup
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-red-100 p-3 rounded-lg mr-4">
                                <i data-lucide="trash-2" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">Clear Data</h3>
                                <p class="text-sm text-gray-500">Remove tickets or cached emails</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <button onclick="clearData('tickets')" class="w-full flex items-center justify-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                                <i data-lucide="trash" class="w-4 h-4 mr-2"></i>
                                Clear All Tickets
                            </button>
                            <button onclick="clearData('emails')" class="w-full flex items-center justify-center px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                                <i data-lucide="trash" class="w-4 h-4 mr-2"></i>
                                Clear Cached Emails
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- System Info Section -->
            <div id="section-system" class="section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">System Info</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center">
                            <div class="bg-green-100 p-3 rounded-lg mr-4">
                                <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Server Status</p>
                                <h3 class="text-lg font-bold text-green-600">Running</h3>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-3 rounded-lg mr-4">
                                <i data-lucide="ticket" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Total Tickets</p>
                                <h3 class="text-lg font-bold text-gray-800" id="statTickets">0</h3>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center">
                            <div class="bg-purple-100 p-3 rounded-lg mr-4">
                                <i data-lucide="mail" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500">Cached Emails</p>
                                <h3 class="text-lg font-bold text-gray-800" id="statEmails">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Last Scan</h3>
                    <p class="text-gray-700" id="lastScanTime">Never</p>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">About</h3>
                    <p class="text-gray-600">IT Ticket Management System</p>
                    <p class="text-sm text-gray-500">Version 1.0.0</p>
                    <p class="text-sm text-gray-500 mt-2">Server running on port 8000</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Modal -->
    <div id="filterModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800" id="filterModalTitle">Add New Filter</h3>
                <button onclick="closeFilterModal()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="filterForm" class="space-y-4">
                <input type="hidden" id="filterId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="filterName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">From Email</label>
                    <input type="text" id="filterFromEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Subject Filter</label>
                    <input type="text" id="filterSubject" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder='contains(subject, "text")'>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Body Filter</label>
                    <input type="text" id="filterBody" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">To Email</label>
                    <input type="text" id="filterToEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Action</label>
                    <select id="filterAction" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Select Action</option>
                        <option value="extract_cdc">extract_cdc</option>
                        <option value="send_mx_alert">send_mx_alert</option>
                        <option value="urgent_mx_notification">urgent_mx_notification</option>
                        <option value="process_health_data">process_health_data</option>
                        <option value="log_cdc_data">log_cdc_data</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <input type="text" id="filterDescription" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="flex items-center">
                        <input type="checkbox" id="filterEnabled" class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500" checked>
                        <span class="ml-2 text-gray-700">Enabled</span>
                    </label>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeFilterModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();

        let currentFilters = [];

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('section-' + section).classList.add('active');
            event.target.closest('.nav-item')?.classList.add('active');
            
            if (section === 'filters') loadFilters();
            if (section === 'system') loadStats();
            if (section === 'tickets') loadSettings();
        }

        async function loadFilters() {
            try {
                console.log('Loading filters from /api/filters...');
                const res = await fetch('/api/filters');
                console.log('Response status:', res.status);
                currentFilters = await res.json();
                console.log('Filters loaded:', currentFilters);
                renderFilters();
            } catch (e) {
                console.error('Error loading filters:', e);
                document.getElementById('filtersTable').innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-red-500">Error loading filters: ' + e.message + '</td></tr>';
            }
        }

        function renderFilters() {
            const tbody = document.getElementById('filtersTable');
            if (currentFilters.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">No filters found</td></tr>';
                return;
            }
            tbody.innerHTML = currentFilters.map(f => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 text-sm text-gray-700">${f.id}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-800">${f.name || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${f.from_email || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${f.subject_filter || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${f.action || '-'}</td>
                    <td class="px-4 py-3">
                        <button onclick="toggleFilter(${f.id})" class="px-2 py-1 text-xs rounded ${f.enabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                            ${f.enabled ? 'Enabled' : 'Disabled'}
                        </button>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="editFilter(${f.id})" class="text-blue-600 hover:text-blue-800 mr-3">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteFilter(${f.id})" class="text-red-600 hover:text-red-800">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function openFilterModal(filter = null) {
            document.getElementById('filterModal').classList.remove('hidden');
            document.getElementById('filterModalTitle').textContent = filter ? 'Edit Filter' : 'Add New Filter';
            document.getElementById('filterId').value = filter?.id || '';
            document.getElementById('filterName').value = filter?.name || '';
            document.getElementById('filterFromEmail').value = filter?.from_email || '';
            document.getElementById('filterSubject').value = filter?.subject_filter || '';
            document.getElementById('filterBody').value = filter?.body_filter || '';
            document.getElementById('filterToEmail').value = filter?.to_email || '';
            document.getElementById('filterAction').value = filter?.action || '';
            document.getElementById('filterDescription').value = filter?.description || '';
            document.getElementById('filterEnabled').checked = filter?.enabled !== false;
        }

        function closeFilterModal() {
            document.getElementById('filterModal').classList.add('hidden');
        }

        function editFilter(id) {
            const filter = currentFilters.find(f => f.id === id);
            if (filter) openFilterModal(filter);
        }

        document.getElementById('filterForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('filterId').value;
            const data = {
                name: document.getElementById('filterName').value,
                from_email: document.getElementById('filterFromEmail').value,
                subject_filter: document.getElementById('filterSubject').value,
                body_filter: document.getElementById('filterBody').value,
                to_email: document.getElementById('filterToEmail').value,
                action: document.getElementById('filterAction').value,
                description: document.getElementById('filterDescription').value,
                enabled: document.getElementById('filterEnabled').checked
            };

            if (id) {
                await fetch(`/api/filters/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            } else {
                await fetch('/api/filters', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
            }
            closeFilterModal();
            loadFilters();
        };

        async function toggleFilter(id) {
            const filter = currentFilters.find(f => f.id === id);
            if (filter) {
                await fetch(`/api/filters/${id}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({enabled: !filter.enabled})
                });
                loadFilters();
            }
        }

        async function deleteFilter(id) {
            if (confirm('Are you sure you want to delete this filter?')) {
                await fetch(`/api/filters/${id}`, {method: 'DELETE'});
                loadFilters();
            }
        }

        async function runScan(mode) {
            const btn = mode === 'quick' ? document.getElementById('quickScanBtn') : document.getElementById('fullScanBtn');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 mr-2 animate-spin"></i> Scanning...';
            lucide.createIcons();

            document.getElementById('scanStatus').classList.remove('hidden');
            document.getElementById('scanResult').classList.add('hidden');

            try {
                const res = await fetch('/api/scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({mode})
                });
                const data = await res.json();

                document.getElementById('scanStatus').classList.add('hidden');
                document.getElementById('scanResult').classList.remove('hidden');
                document.getElementById('scanResultText').textContent = data.message || 'Scan completed successfully!';

                const autoRefresh = document.getElementById('autoRefreshAfterScan').checked;
                if (autoRefresh) {
                    setTimeout(() => window.location.href = 'dashboard.html', 2000);
                }
            } catch (e) {
                document.getElementById('scanStatus').classList.add('hidden');
                alert('Scan failed: ' + e.message);
            }

            btn.disabled = false;
            btn.innerHTML = mode === 'quick' 
                ? '<i data-lucide="play" class="w-4 h-4 mr-2"></i> Start Quick Scan'
                : '<i data-lucide="play" class="w-4 h-4 mr-2"></i> Start Full Scan';
            lucide.createIcons();
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const settings = await res.json();
                document.getElementById('defaultStatus').value = settings.default_status || 'in progress';
                document.getElementById('defaultHandler').value = settings.default_handler || 'USE_MISSING';
                document.getElementById('autoRefreshEnabled').checked = settings.auto_refresh || false;
                document.getElementById('refreshInterval').value = settings.refresh_interval || 60;
                document.getElementById('autoRefreshAfterScan').checked = settings.auto_refresh_after_scan || false;
            } catch (e) {
                console.error('Error loading settings:', e);
            }
        }

        async function saveSettings() {
            const settings = {
                default_status: document.getElementById('defaultStatus').value,
                default_handler: document.getElementById('defaultHandler').value,
                auto_refresh: document.getElementById('autoRefreshEnabled').checked,
                refresh_interval: parseInt(document.getElementById('refreshInterval').value),
                auto_refresh_after_scan: document.getElementById('autoRefreshAfterScan').checked
            };

            await fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings)
            });
            alert('Settings saved!');
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/stats');
                const stats = await res.json();
                document.getElementById('statTickets').textContent = stats.ticket_count || 0;
                document.getElementById('statEmails').textContent = stats.email_count || 0;
                document.getElementById('lastScanTime').textContent = stats.last_scan || 'Never';
            } catch (e) {
                console.error('Error loading stats:', e);
            }
        }

        async function exportData(type) {
            try {
                const ticketRes = await fetch('/database/ticket.json');
                const tickets = await ticketRes.json();
                
                const blob = new Blob([JSON.stringify(tickets, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = type === 'tickets' ? 'tickets_export.json' : 'emails_export.json';
                a.click();
            } catch (e) {
                alert('Export failed: ' + e.message);
            }
        }

        async function createBackup() {
            if (confirm('Create a backup of all data?')) {
                try {
                    await fetch('/api/backup', {method: 'POST'});
                    alert('Backup created successfully!');
                } catch (e) {
                    alert('Backup failed: ' + e.message);
                }
            }
        }

        async function clearData(type) {
            const msg = type === 'tickets' 
                ? 'Are you sure you want to clear ALL tickets? This cannot be undone!'
                : 'Are you sure you want to clear all cached emails?';
            if (confirm(msg)) {
                try {
                    await fetch('/api/clear-' + type, {method: 'POST'});
                    alert(type + ' cleared!');
                    loadStats();
                } catch (e) {
                    alert('Clear failed: ' + e.message);
                }
            }
        }

        loadFilters();
    </script>
</body>
</html>
